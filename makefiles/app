### Variables ###

# Project name
PROJECT_NAME ?= $(shell basename $(PWD))

# Current environment
export NODE_ENV ?= development

# Application config dir
export NODE_CONFIG_DIR ?= $(CONFIGS_PATH)/app

# Node path
NODE_BIN_PATH ?= /usr/bin /usr/local/bin

# Node bin
NODE ?= $(shell find $(NODE_BIN_PATH) -name node \( -type f -or -type l \))

# Process manager
PROCESS_MANAGER ?= pm2

### Application ###

# Start application
.PHONY: start
start:
	@echo '===> Running the application'
	@echo 'User: $(shell whoami)'
	@echo 'Environment: $(PROJECT_NAME)'
	@echo 'Nodejs version: $(shell $(NODE) --version)'

	if ($(PROCESS_MANAGER) list | grep $(PROJECT_NAME)); then \
        $(PROCESS_MANAGER) restart $(PROJECT_NAME); \
	else \
        $(PROCESS_MANAGER) start index.js \
            -n $(PROJECT_NAME) \
            --no-autorestart \
            --log-date-format='YYYY-MM-DD HH:mm:ss.SSS'; \
	fi

# Stop application
.PHONY: stop
stop:
	@echo '===> Stoping the application'

	$(PROCESS_MANAGER) delete $(PROJECT_NAME)

# Restart application
.PHONY: restart
restart:
	@echo '===> Restarting the application'

	$(PROCESS_MANAGER) restart $(PROJECT_NAME)

### Debug ###

# Show current process
.PHONY: process.show
process.show:
	@echo '===> Current process'

	$(PROCESS_MANAGER) show $(PROJECT_NAME)

# Show logs
.PHONY: logs.show
logs.show:
	@echo '===> Logs'

	$(PROCESS_MANAGER) logs $(PROJECT_NAME)
